<!DOCTYPE html>
<html>
<head>
    <title>Вхід до Чату</title>
    <style>
        body { font-family: sans-serif; display: grid; place-items: center; min-height: 90vh; background: #f4f4f4; }
        .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 300px; }
        h1 { text-align: center; color: #333; margin-top: 0; }
        form { display: flex; flex-direction: column; gap: 10px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #response-message { margin-top: 15px; text-align: center; font-size: 0.9em; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Вхід або Реєстрація</h1>
        
        <form id="auth-form">
            <label for="username">Логін:</label>
            <input type="text" id="username" required>
            
            <label for="password">Пароль:</label>
            <input type="password" id="password" required>
            
            <button type="submit" id="login-btn">Увійти</button>
            <button type="button" id="register-btn">Зареєструватися</button>
        </form>
        
        <div id="response-message"></div>
    </div>

    <script>
        // --- 1. Отримуємо доступ до елементів ---
        const form = document.getElementById('auth-form');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const responseMsg = document.getElementById('response-message');

        // --- 2. Обробник: Реєстрація ---
        registerBtn.onclick = async function(event) {
            event.preventDefault(); // Зупиняємо стандартну поведінку кнопки
            const username = usernameInput.value;
            const password = passwordInput.value;

            // 'fetch' - це JavaScript спосіб "смикнути" ендпоінт
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            });

            const data = await response.json(); // Читаємо відповідь від сервера

            if (response.ok) {
                responseMsg.textContent = data.message; // "Користувач ... зареєстрований!"
                responseMsg.className = 'success';
            } else {
                responseMsg.textContent = data.detail; // "Цей username вже зайнятий"
                responseMsg.className = 'error';
            }
        };

        // --- 3. Обробник: Вхід (Логін) ---
        // Ми вішаємо обробник на 'submit' всієї форми
        form.onsubmit = async function(event) {
            event.preventDefault(); // Запобігаємо перезавантаженню сторінки
            const username = usernameInput.value;
            const password = passwordInput.value;

            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            });

            const data = await response.json(); 

            if (response.ok) {
                // УСПІХ! Сервер повернув нам "квиток" (токен)
                responseMsg.textContent = 'Вхід успішний! Перенаправлення...';
                responseMsg.className = 'success';

                // ЦЕ НАЙГОЛОВНІШЕ:
                // Зберігаємо "квиток" у локальному сховищі браузера
                localStorage.setItem('chat-token', data.access_token);

                // Чекаємо 1 секунду (щоб користувач побачив повідомлення) 
                // і перекидаємо його на головну сторінку чату
                setTimeout(() => {
                    window.location.href = '/'; // Перехід на сторінку чату
                }, 1000);

            } else {
                // ПОМИЛКА!
                responseMsg.textContent = data.detail; // "Неправильний username або пароль"
                responseMsg.className = 'error';
            }
        };
    </script>
</body>
</html>