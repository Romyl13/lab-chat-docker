<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∞–±–∞ 6: –í–µ–±-—á–∞—Ç</title>
    <style>
        :root {
            --bg-color: #f9f9f9;
            --chat-bg: white;
            --sidebar-bg: #f1f1f1;
            --text-color: #333;
            --border-color: #ccc;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --logout-bg: #dc3545;
            --logout-hover: #a71d2a;
            --info-text: #666;
            --history-text: #0056b3;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --chat-bg: #2b2b2b;
            --sidebar-bg: #222;
            --text-color: #f1f1f1;
            --border-color: #555;
            --button-bg: #0056b3;
            --button-hover: #003d80;
            --logout-bg: #a71d2a;
            --logout-hover: #dc3545;
            --info-text: #aaa;
            --history-text: #58a6ff;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0; /* –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø–∏ —Ç—ñ–ª–∞ */
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
            display: flex; /* –ì–æ–ª–æ–≤–Ω–∏–π flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
            height: 100vh; /* –ù–∞ –≤—Å—é –≤–∏—Å–æ—Ç—É –µ–∫—Ä–∞–Ω—É */
            overflow: hidden; /* –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ç—ñ–ª–∞ */
        }

        /* --- 1. –ù–û–í–ï: –ë—ñ—á–Ω–∞ –ø–∞–Ω–µ–ª—å (–°–∞–π–¥–±–∞—Ä) --- */
        #user-sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
        }
        
        #user-sidebar h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        #user-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞, —è–∫—â–æ —é–∑–µ—Ä—ñ–≤ –±–∞–≥–∞—Ç–æ */
        }
        
        #user-list li {
            padding: 5px 0;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ "–°—Ö–æ–≤–∞—Ç–∏/–ü–æ–∫–∞–∑–∞—Ç–∏" —Å–∞–π–¥–±–∞—Ä */
        #toggle-sidebar {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            z-index: 1001; /* –ü–æ–≤–µ—Ä—Ö —É—Å—å–æ–≥–æ */
        }
        
        /* –°—Ç–∞–Ω "–°—Ö–æ–≤–∞–Ω–æ" */
        body.sidebar-hidden #user-sidebar {
            margin-left: -250px; /* –•–æ–≤–∞—î–º–æ –∑–∞ –∫—Ä–∞–π –µ–∫—Ä–∞–Ω—É */
        }
        
        /* --- 2. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç—É (–û–ù–û–í–õ–ï–ù–û) --- */
        .chat-container {
            flex-grow: 1; /* –ó–∞–π–º–∞—î –≤–µ—Å—å –∑–∞–ª–∏—à–æ–∫ –º—ñ—Å—Ü—è */
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100vh; /* –ù–∞ –≤—Å—é –≤–∏—Å–æ—Ç—É */
            box-sizing: border-box;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            padding-left: 40px; /* –í—ñ–¥—Å—Ç—É–ø –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–±—É—Ä–≥–µ—Ä–∞" */
        }
        
        h1 { margin: 0; }
        .header-buttons { display: flex; gap: 10px; }

        #theme-toggle {
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
        }

        button { /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (–±–µ–∑ –∑–º—ñ–Ω) */ }
        
        #chat-box {
            flex-grow: 1; /* –ó–∞–π–º–∞—î –≤–µ—Å—å –≤—ñ–ª—å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –ø–æ –≤–∏—Å–æ—Ç—ñ */
            border: 1px solid var(--border-color);
            background: var(--chat-bg);
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        
        .msg-info, .msg-history { /* ... (—Å—Ç–∏–ª—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –±–µ–∑ –∑–º—ñ–Ω) ... */ }
        
        #message-form { display: flex; }
        #message-text { flex-grow: 1; /* ... (—ñ–Ω—à—ñ —Å—Ç–∏–ª—ñ –±–µ–∑ –∑–º—ñ–Ω) ... */ }
        
        /* --- 3. –ê–¥–∞–ø—Ç–∏–≤ (–û–ù–û–í–õ–ï–ù–û) --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column; /* –ù–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É –≤—Å–µ —Å—Ç–∞—î –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
            }
            
            #user-sidebar {
                width: 100%; /* –°–∞–π–¥–±–∞—Ä –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
                height: 200px; /* –ê–ª–µ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ—ó –≤–∏—Å–æ—Ç–∏ */
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                transition: margin-top 0.3s ease; /* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—ñ */
            }

            /* –°—Ç–∞–Ω "–°—Ö–æ–≤–∞–Ω–æ" –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
            body.sidebar-hidden #user-sidebar {
                margin-left: 0; /* –°–∫–∏–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ */
                margin-top: -200px; /* –•–æ–≤–∞—î–º–æ –∑–∞ –≤–µ—Ä—Ö–Ω—ñ–π –∫—Ä–∞–π */
            }

            .chat-container {
                height: auto; /* –í–∏—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ */
            }
            
            .chat-header {
                padding-left: 0; /* –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø */
                justify-content: center; /* –¶–µ–Ω—Ç—Ä—É—î–º–æ header */
            }
            
            #toggle-sidebar {
                /* –ü–µ—Ä–µ–º—ñ—â—É—î–º–æ –∫–Ω–æ–ø–∫—É –≤ –∫—É—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–∞—Ç—É */
                position: relative;
                top: 0;
                left: 0;
                align-self: flex-start;
            }
        }

    </style>
</head>
<body>

    <button id="toggle-sidebar">‚ò∞</button>

    <aside id="user-sidebar">
        <h2>–û–Ω–ª–∞–π–Ω: <span id="user-count">0</span></h2>
        <ul id="user-list">
            </ul>
    </aside>

    <div class="chat-container">
        
        <div class="chat-header">
            <h1>–í–∏–∫–æ–Ω–∞–≤ - –í–æ–ª–æ—à–∏–Ω –†–æ–º–∞–Ω —Å—Ç—É–¥–µ–Ω—Ç –≥—Ä—É–ø–∏ –ö–ù–®–Ü-31</h1>
            <div class="header-buttons">
                <button id="sound-btn">–ó–¥–∞—Ä–æ–≤–∞!</button>
                <button id="theme-toggle">üåô</button>
                <button id="logout-btn">–í–∏–π—Ç–∏</button>
            </div>
        </div>

        <div id="chat-box">
            <div>–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞...</div>
        </div>

        <form id="message-form">
            <input type="text" id="message-text" autocomplete="off" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —â–æ—Å—å..."/>
            <button>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        </form>
    </div>

    <audio id="my-sound" src="https://www.myinstants.com/media/sounds/zdarova-bandity.mp3" preload="auto"></audio>

    <script>
        // --- 1. –ö–†–ò–¢–ò–ß–ù–ò–ô –∫–æ–¥ —á–∞—Ç—É (–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—É) ---
        const token = localStorage.getItem('chat-token');
        if (!token) {
            alert("–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å.");
            window.location.href = '/login';
        } else {
            
            // --- 2. –ó–Ω–∞—Ö–æ–¥–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ (—Å—Ç–∞—Ä—ñ + –ù–û–í–Ü) ---
            const chatBox = document.getElementById('chat-box');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-text');
            const logoutBtn = document.getElementById('logout-btn');
            // –ù–û–í–Ü –ï–õ–ï–ú–ï–ù–¢–ò
            const userList = document.getElementById('user-list');
            const userCount = document.getElementById('user-count');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar');
            const body = document.body; // –í–∂–µ –±—É–ª–æ –¥–ª—è —Ç–µ–º–∏, —Ç–µ–ø–µ—Ä —ñ –¥–ª—è —Å–∞–π–¥–±–∞—Ä—É

            // --- 3. –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è WebSocket (–±–µ–∑ –∑–º—ñ–Ω) ---
            const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws?token=${token}`);

            // --- 4. –û–±—Ä–æ–±–Ω–∏–∫: –©–æ —Ä–æ–±–∏—Ç–∏, –ö–û–õ–ò –ü–†–ò–ô–®–õ–û –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–ö–†–ò–¢–ò–ß–ù–û –û–ù–û–í–õ–ï–ù–û) ---
            ws.onmessage = function(event) {
                // –¢–µ–ø–µ—Ä –º–∏ –æ—á—ñ–∫—É—î–º–æ JSON, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
                const data = JSON.parse(event.data);

                // –î–∏–≤–∏–º–æ—Å—å, –Ø–ö–ò–ô –¢–ò–ü –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏–π—à–æ–≤
                if (data.type === 'chat') {
                    // --- –¶–µ –∑–≤–∏—á–∞–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–∞—Ç—É ---
                    const messageElement = document.createElement('div');
                    messageElement.textContent = data.message; // –ë–µ—Ä–µ–º–æ —Ç–µ–∫—Å—Ç –∑ data.message

                    if (data.message.startsWith('INFO:')) {
                        messageElement.className = 'msg-info';
                    } else if (data.message.startsWith('[–Ü—Å—Ç–æ—Ä—ñ—è]')) {
                        messageElement.className = 'msg-history';
                    }
                    
                    chatBox.appendChild(messageElement);
                    chatBox.scrollTop = chatBox.scrollHeight;

                } else if (data.type === 'user_list') {
                    // --- –¶–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ ---
                    updateUserList(data.users);
                }
            };

            // --- 5. –ù–û–í–ê –§—É–Ω–∫—Ü—ñ—è: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —é–∑–µ—Ä—ñ–≤ ---
            function updateUserList(users) {
                userList.innerHTML = ''; // –ü–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—â—É—î–º–æ —Å—Ç–∞—Ä–∏–π —Å–ø–∏—Å–æ–∫
                userCount.textContent = users.length; // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫

                users.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = user;
                    userList.appendChild(li);
                });
            }

            // --- 6. –û–±—Ä–æ–±–Ω–∏–∫–∏ (–ë–µ–∑–ø–µ–∫–∞, –§–æ—Ä–º–∞, –í–∏—Ö—ñ–¥) (–±–µ–∑ –∑–º—ñ–Ω) ---
            ws.onerror = function() { /* ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ... */ };
            messageForm.onsubmit = function(event) { /* ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ... */ };
            logoutBtn.onclick = function() { /* ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ... */ };
            
            // --- 7. –û–±—Ä–æ–±–Ω–∏–∫–∏ (–ó–≤—É–∫, –¢–µ–º–∞) (–±–µ–∑ –∑–º—ñ–Ω) ---
            const soundBtn = document.getElementById('sound-btn');
            const mySound = document.getElementById('my-sound');
            soundBtn.onclick = function() { mySound.play(); };
            
            const themeToggle = document.getElementById('theme-toggle');
            if (localStorage.getItem('chat-theme') === 'dark') { /* ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ... */ }
            themeToggle.onclick = function() { /* ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ... */ };

            // --- 8. –ù–û–í–ò–ô –û–±—Ä–æ–±–Ω–∏–∫: –ö–Ω–æ–ø–∫–∞ "–°—Ö–æ–≤–∞—Ç–∏/–ü–æ–∫–∞–∑–∞—Ç–∏" —Å–∞–π–¥–±–∞—Ä ---
            toggleSidebarBtn.onclick = function() {
                body.classList.toggle('sidebar-hidden');
            };
            
            // --- –ö–æ–ø—ñ—é—î–º–æ —Å—Ç–∞—Ä–∏–π –∫–æ–¥ (—â–æ–± JS –Ω–µ –ª–∞—è–≤—Å—è) ---
            // –¶–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –±–æ –º–∏ –≤–∏–Ω–µ—Å–ª–∏ —Ü—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤ –Ω–æ–≤—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
            ws.onerror = function() {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è. –ú–æ–∂–ª–∏–≤–æ, –≤–∞—à —Ç–æ–∫–µ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–≤. –°–ø—Ä–æ–±—É–π—Ç–µ —É–≤—ñ–π—Ç–∏ –∑–Ω–æ–≤—É.");
                localStorage.removeItem('chat-token');
                window.location.href = '/login';
            };
            messageForm.onsubmit = function(event) {
                event.preventDefault(); 
                const message = messageInput.value;
                if (message.trim() !== "") {
                    ws.send(message);
                    messageInput.value = '';
                }
            };
            logoutBtn.onclick = function() {
                localStorage.removeItem('chat-token');
                alert('–í–∏ –≤–∏–π—à–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏.');
                window.location.href = '/login';
            };
            if (localStorage.getItem('chat-theme') === 'dark') {
                body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            }
            themeToggle.onclick = function() {
                body.classList.toggle('dark-mode');
                if (body.classList.contains('dark-mode')) {
                    localStorage.setItem('chat-theme', 'dark');
                    themeToggle.textContent = '‚òÄÔ∏è';
                } else {
                    localStorage.setItem('chat-theme', 'light');
                    themeToggle.textContent = 'üåô';
                }
            };
        }
    </script>
</body>
</html>