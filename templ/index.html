<!DOCTYPE html>
<html>
    <head>
        <title>Лаба 6: Веб-чат</title>
        <style>
            /* Стилі залишаються ті самі, що й були */
            body { font-family: sans-serif; margin: 20px; background: #f9f9f9; }
            #chat-box {
                width: 90%;
                height: 400px;
                border: 1px solid #ccc;
                background: white;
                overflow-y: scroll; 
                padding: 10px;
                margin-bottom: 10px;
            }
            #message-form { display: flex; }
            #message-text { flex-grow: 1; padding: 8px; border: 1px solid #ddd; }
            button { padding: 8px 15px; background: #007bff; color: white; border: none; }
            #logout-btn { background: #dc3545; cursor: pointer; margin-left: 10px; }
        </style>
    </head>
    <body>
        <h1>Мій WebSocket Чат</h1>
        <button id="logout-btn">Вийти</button>
        
        <div id="chat-box">
            <div>Підключення до сервера...</div>
        </div>

        <form id="message-form">
            <input type="text" id="message-text" autocomplete="off" placeholder="Напишіть щось..."/>
            <button>Надіслати</button>
        </form>

        <script>
            // --- 1. Перевірка "квитка" (токену) ---
            // Дістаємо "квиток" з кишені (localStorage)
            const token = localStorage.getItem('chat-token');

            if (!token) {
                // ЯКЩО "КВИТКА" НЕМАЄ:
                // Негайно перекидаємо користувача на сторінку логіну
                alert("Ви не авторизовані. Будь ласка, увійдіть.");
                window.location.href = '/login';
            } else {
                // ЯКЩО "КВИТОК" Є:
                
                // --- 2. Отримуємо доступ до HTML елементів ---
                const chatBox = document.getElementById('chat-box');
                const messageForm = document.getElementById('message-form');
                const messageInput = document.getElementById('message-text');
                const logoutBtn = document.getElementById('logout-btn');

                // --- 3. Створюємо WebSocket з'єднання ---
                
                // Визначаємо протокол (для Render)
                const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';

                // ЦЕ НАЙГОЛОВНІШЕ ОНОВЛЕННЯ:
                // Ми "прикріплюємо" наш "квиток" (токен) до адреси підключення.
                // Сервер у 'chat.py' (@app.websocket) його там "спіймає".
                const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws?token=${token}`);

                // --- 4. Обробник: Що робити, КОЛИ ПРИЙШЛО повідомлення ---
                ws.onmessage = function(event) {
                    const messageElement = document.createElement('div');
                    messageElement.textContent = event.data;

                    // Робимо системні повідомлення курсивом
                    if (event.data.startsWith('INFO:')) {
                        messageElement.style.fontStyle = 'italic';
                        messageElement.style.color = '#666';
                    }
                    
                    chatBox.appendChild(messageElement);
                    chatBox.scrollTop = chatBox.scrollHeight;
                };

                // Обробник помилки (напр. якщо токен "протух")
                ws.onerror = function() {
                    alert("Помилка підключення. Можливо, ваш токен застарів. Спробуйте увійти знову.");
                    localStorage.removeItem('chat-token'); // Видаляємо поганий квиток
                    window.location.href = '/login';
                };

                // --- 5. Обробник: Що робити, КОЛИ МИ ВІДПРАВЛЯЄМО ---
                messageForm.onsubmit = function(event) {
                    event.preventDefault(); 
                    const message = messageInput.value;
                    if (message.trim() !== "") { // Не надсилаємо порожні повідомлення
                        ws.send(message);
                        messageInput.value = '';
                    }
                };

                // --- 6. Обробник: Вихід ---
                logoutBtn.onclick = function() {
                    localStorage.removeItem('chat-token'); // Викидаємо "квиток"
                    alert('Ви вийшли з системи.');
                    window.location.href = '/login'; // Повертаємось на сторінку логіну
                };
            }
        </script>
    </body>
</html>