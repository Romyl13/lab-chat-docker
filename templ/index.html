<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∞–±–∞ 6: –í–µ–±-—á–∞—Ç</title>
    <style>
        /* --- 2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CSS –ó–º—ñ–Ω–Ω–∏—Ö (–¥–ª—è —Ç–µ–º–Ω–æ—ó/—Å–≤—ñ—Ç–ª–æ—ó —Ç–µ–º–∏) --- */
        :root {
            --bg-color: #f9f9f9;
            --chat-bg: white;
            --text-color: #333;
            --border-color: #ccc;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --logout-bg: #dc3545;
            --logout-hover: #a71d2a;
            --info-text: #666;
            --history-text: #0056b3;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --chat-bg: #2b2b2b;
            --text-color: #f1f1f1;
            --border-color: #555;
            --button-bg: #0056b3;
            --button-hover: #003d80;
            --logout-bg: #a71d2a;
            --logout-hover: #dc3545;
            --info-text: #aaa;
            --history-text: #58a6ff;
        }
        /* --- –ö—ñ–Ω–µ—Ü—å –ó–º—ñ–Ω–Ω–∏—Ö --- */

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 1rem;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
        }

        /* --- 3. –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —á–∞—Ç—É --- */
        .chat-container {
            width: 95%; /* –ù–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É 95% —à–∏—Ä–∏–Ω–∏ */
            max-width: 800px; /* –ù–∞ –ü–ö –Ω–µ —à–∏—Ä—à–µ 800px */
            margin: 0 auto; /* –¶–µ–Ω—Ç—Ä—É—î–º–æ */
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            justify-content: space-between; /* –†–æ–∑–Ω–æ—Å–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ –ø–æ –±–æ–∫–∞—Ö */
            align-items: center;
            flex-wrap: wrap; /* –î–æ–∑–≤–æ–ª—è—î–º–æ –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É */
            gap: 10px; /* –í—ñ–¥—Å—Ç—É–ø –º—ñ–∂ –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
            margin-bottom: 10px;
        }
        
        h1 { margin: 0; }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        #theme-toggle {
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        #chat-box {
            width: 100%; /* –¢–µ–ø–µ—Ä 100% –≤—ñ–¥ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ .chat-container */
            height: 400px;
            border: 1px solid var(--border-color);
            background: var(--chat-bg);
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box; /* –í–∞–∂–ª–∏–≤–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö 100% */
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
        .msg-info { font-style: italic; color: var(--info-text); }
        .msg-history { color: var(--history-text); }
        
        #message-form { display: flex; }
        
        #message-text {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            background: var(--chat-bg);
            color: var(--text-color);
        }
        
        #message-form button { background: var(--button-bg); }
        #message-form button:hover { background: var(--button-hover); }
        
        #logout-btn { background: var(--logout-bg); }
        #logout-btn:hover { background: var(--logout-hover); }
        
        #sound-btn { background: #28a745; }
        #sound-btn:hover { background: #1e7e34; }
    </style>
</head>
<body>

    <div class="chat-container">
        
        <div class="chat-header">
            <h1>–ú—ñ–π WebSocket –ß–∞—Ç</h1>
            <div class="header-buttons">
                <button id="sound-btn">–ó–¥–∞—Ä–æ–≤–∞!</button>
                <button id="theme-toggle">üåô</button>
                <button id="logout-btn">–í–∏–π—Ç–∏</button>
            </div>
        </div>

        <div id="chat-box">
            <div>–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞...</div>
        </div>

        <form id="message-form">
            <input type="text" id="message-text" autocomplete="off" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —â–æ—Å—å..."/>
            <button>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        </form>
    </div>

    <audio id="my-sound" src="https://www.myinstants.com/media/sounds/zdarova-bandity.mp3" preload="auto"></audio>

    <script>
        // --- 1. –ö–†–ò–¢–ò–ß–ù–ò–ô –∫–æ–¥ —á–∞—Ç—É (–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—É) ---
        // –¶–µ–π –∫–æ–¥ –Ω–µ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏!
        const token = localStorage.getItem('chat-token');
        if (!token) {
            alert("–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å.");
            window.location.href = '/login';
        } else {
            
            // --- 2. –°—Ç–∞—Ä–∏–π –∫–æ–¥ —á–∞—Ç—É (–ó–Ω–∞—Ö–æ–¥–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏) ---
            const chatBox = document.getElementById('chat-box');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-text');
            const logoutBtn = document.getElementById('logout-btn');

            // --- 3. –°—Ç–∞—Ä–∏–π –∫–æ–¥ —á–∞—Ç—É (–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è WebSocket) ---
            const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws?token=${token}`);

            // --- 4. –°—Ç–∞—Ä–∏–π –∫–æ–¥ —á–∞—Ç—É (–û–±—Ä–æ–±–Ω–∏–∫–∏) ---
            ws.onmessage = function(event) {
                const messageElement = document.createElement('div');
                messageElement.textContent = event.data;

                // –û–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–∏—Ö —Å—Ç–∏–ª—ñ–≤
                if (event.data.startsWith('INFO:')) {
                    messageElement.className = 'msg-info';
                } else if (event.data.startsWith('[–Ü—Å—Ç–æ—Ä—ñ—è]')) {
                    messageElement.className = 'msg-history';
                }
                
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            };

            ws.onerror = function() {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è. –ú–æ–∂–ª–∏–≤–æ, –≤–∞—à —Ç–æ–∫–µ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–≤. –°–ø—Ä–æ–±—É–π—Ç–µ —É–≤—ñ–π—Ç–∏ –∑–Ω–æ–≤—É.");
                localStorage.removeItem('chat-token');
                window.location.href = '/login';
            };

            messageForm.onsubmit = function(event) {
                event.preventDefault(); 
                const message = messageInput.value;
                if (message.trim() !== "") {
                    ws.send(message);
                    messageInput.value = '';
                }
            };

            logoutBtn.onclick = function() {
                localStorage.removeItem('chat-token');
                alert('–í–∏ –≤–∏–π—à–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏.');
                window.location.href = '/login';
            };

            // --- 5. –ù–û–í–ò–ô –∫–æ–¥ –¥–ª—è –ó–≤—É–∫—É ---
            const soundBtn = document.getElementById('sound-btn');
            const mySound = document.getElementById('my-sound');
            soundBtn.onclick = function() {
                mySound.play();
            };

            // --- 6. –ù–û–í–ò–ô –∫–æ–¥ –¥–ª—è –¢–µ–º–Ω–æ—ó –¢–µ–º–∏ ---
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.body;

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ localStorage –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
            if (localStorage.getItem('chat-theme') === 'dark') {
                body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            }

            themeToggle.onclick = function() {
                body.classList.toggle('dark-mode');
                
                if (body.classList.contains('dark-mode')) {
                    localStorage.setItem('chat-theme', 'dark');
                    themeToggle.textContent = '‚òÄÔ∏è';
                } else {
                    localStorage.setItem('chat-theme', 'light');
                    themeToggle.textContent = 'üåô';
                }
            };
        }
    </script>
</body>
</html>